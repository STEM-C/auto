let expect,createAxiosInstance,getAppName,createApp,deleteApp,run,dotenv;_e16‍.w("chai",[["expect",["expect"],function(v){expect=v}]]);_e16‍.w("./util",[["createAxiosInstance",["createAxiosInstance"],function(v){createAxiosInstance=v}],["getAppName",["getAppName"],function(v){getAppName=v}]]);_e16‍.w("./dataaccess",[["createApp",["createApp"],function(v){createApp=v}],["deleteApp",["deleteApp"],function(v){deleteApp=v}]]);_e16‍.w("./controller",[["run",["run"],function(v){run=v}]]);_e16‍.w("dotenv",[["*",null,function(v){dotenv=v}]]);





dotenv.config()

let instance

describe('auto', async function() {
    describe('review', async function() {        
        describe('util', async function() {
            it('should create an axios instance', async function() {

                const host = 'https://api.heroku.com'
                const token = process.env.HEROKU_TOKEN

                instance = createAxiosInstance(host, token)

                expect(instance.defaults.baseURL).to.equal(`${host}/`)
            })
        })
        
        describe('dataaccess', async function() {
            it('should create an app', async function() {

                const pipeline = process.env.PIPELINE_ID
                const stage = 'development'
                const name = getAppName('stem-c', 1)

                let response, error
                try {
                    response = await createApp(instance, pipeline, stage, name)
                } catch (err) {
                    error = err   
                }

                expect(error).to.not.exist
                expect(response).to.exist
                expect(response).to.haveOwnProperty('app_name').equals(name)
                expect(response).to.haveOwnProperty('DATABASE_URL')
            })

            it('should delete an app', async function() {

                const name = getAppName('stem-c', 1)

                let error
                try {
                    await deleteApp(instance, name)
                } catch (err) {
                    error = err   
                }

                expect(error).to.not.exist
            })
        })
        
        describe('controller', async function() {
            it('should create an app when the pr state is open', async function() {

                const request = {
                    base: 'stem-c',
                    pipeline: process.env.PIPELINE_ID,
                    stage: 'development',
                    token: process.env.HEROKU_TOKEN,
                    state: 'open',
                    pr: '1'
                }
                const name = getAppName(request.base, request.pr)

                let response, error
                try {
                    response = await run(request)
                } catch (err) {
                    error = err   
                }

                expect(error).to.not.exist
                expect(response).to.exist
                expect(response).to.haveOwnProperty('app_name').equals(name)
                expect(response).to.haveOwnProperty('DATABASE_URL')
            })

            it('should delete an app when the pr state is closed', async function() {

                const request = {
                    base: 'stem-c',
                    token: process.env.HEROKU_TOKEN,
                    state: 'closed',
                    pr: '1'
                }

                let error
                try {
                    await run(request)
                } catch (err) {
                    error = err   
                }

                expect(error).to.not.exist
            })

            it('should throw an error when the pr state is not valid', async function() {

                const request = {
                    state: 'invalid'
                }

                let error
                try {
                    await run(request)
                } catch (err) {
                    error = err   
                }

                expect(error).to.exist
            })
        })
    })
})